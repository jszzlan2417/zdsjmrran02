const express=require('express'),app=express(),axios=require('axios'),os=require('os'),fs=require('fs'),path=require('path'),{promisify}=require('util'),exec=promisify(require('child_process')['exec']),{execSync}=require('child_process'),UPLOAD_URL=process['env']['UPLOAD_URL']||'',PROJECT_URL=process['env']['PROJECT_URL']||'',AUTO_ACCESS=process['env']['AUTO_ACCESS']||![],FILE_PATH=process['env']['FILE_PATH']||'./tmp',SUB_PATH=process['env']['SUB_PATH']||'sub',PORT=process['env']['SERVER_PORT']||process['env']['PORT']||0xbb8,UUID=process['env']['UUID']||'db007c77-a3f0-426e-a3d7-3ca391023bcb',NEZHA_SERVER=process['env']['NEZHA_SERVER']||'',NEZHA_PORT=process['env']['NEZHA_PORT']||'',NEZHA_KEY=process['env']['NEZHA_KEY']||'',ARGO_DOMAIN=process['env']['ARGO_DOMAIN']||'22dd.zdsjmrran888.ggff.net',ARGO_AUTH=process['env']['ARGO_AUTH']||'eyJhIjoiNmNhMmUxODZiY2VmYTFlODNiNTdkNjY4NjMzNmJhMTMiLCJ0IjoiMWY0MGQ0OTAtMTZmYS00MjMxLTliZDEtYzA2ODc5YzU2YzhhIiwicyI6IlpqZzVPR05sTWpNdE9UWTBaQzAwTWpReExUbGlZakl0Tm1FME1HRTRaVEkzT1dFeCJ9',ARGO_PORT=process['env']['ARGO_PORT']||0x1f41,CFIP=process['env']['CFIP']||'cdns.doon.eu.org',CFPORT=process['env']['CFPORT']||0x1bb,NAME=process['env']['NAME']||'smdx';!fs['existsSync'](FILE_PATH)?(fs['mkdirSync'](FILE_PATH),console['log'](FILE_PATH+'\x20is\x20created')):console['log'](FILE_PATH+'\x20already\x20exists');function generateRandomName(){const _0xe87eae='abcdefghijklmnopqrstuvwxyz';let _0xc1a266='';for(let _0xca6d3f=0x0;_0xca6d3f<0x6;_0xca6d3f++){_0xc1a266+=_0xe87eae['charAt'](Math['floor'](Math['random']()*_0xe87eae['length']));}return _0xc1a266;}const npmName=generateRandomName(),webName=generateRandomName(),botName=generateRandomName(),phpName=generateRandomName();let npmPath=path['join'](FILE_PATH,npmName),phpPath=path['join'](FILE_PATH,phpName),webPath=path['join'](FILE_PATH,webName),botPath=path['join'](FILE_PATH,botName),subPath=path['join'](FILE_PATH,'sub.txt'),listPath=path['join'](FILE_PATH,'list.txt'),bootLogPath=path['join'](FILE_PATH,'boot.log'),configPath=path['join'](FILE_PATH,'config.json');function deleteNodes(){try{if(!UPLOAD_URL)return;if(!fs['existsSync'](subPath))return;let _0x3df1ba;try{_0x3df1ba=fs['readFileSync'](subPath,'utf-8');}catch{return null;}const _0x497022=Buffer['from'](_0x3df1ba,'base64')['toString']('utf-8'),_0x7405d1=_0x497022['split']('\x0a')['filter'](_0x4f82eb=>/(vless|vmess|trojan|hysteria2|tuic):\/\//['test'](_0x4f82eb));if(_0x7405d1['length']===0x0)return;return axios['post'](UPLOAD_URL+'/api/delete-nodes',JSON['stringify']({'nodes':_0x7405d1}),{'headers':{'Content-Type':'application/json'}})['catch'](_0x1c1e4a=>{return null;}),null;}catch(_0x10cdc4){return null;}}function cleanupOldFiles(){try{const _0xf27189=fs['readdirSync'](FILE_PATH);_0xf27189['forEach'](_0x45fb43=>{const _0x2f45bd=path['join'](FILE_PATH,_0x45fb43);try{const _0x597397=fs['statSync'](_0x2f45bd);_0x597397['isFile']()&&fs['unlinkSync'](_0x2f45bd);}catch(_0x317b72){}});}catch(_0x3a4ba5){}}app['get']('/',function(_0x7b14,_0x16c78a){_0x16c78a['send']('Hello\x20world!');});async function generateConfig(){const _0x205a4e={'log':{'access':'/dev/null','error':'/dev/null','loglevel':'none'},'inbounds':[{'port':ARGO_PORT,'protocol':'vless','settings':{'clients':[{'id':UUID,'flow':'xtls-rprx-vision'}],'decryption':'none','fallbacks':[{'dest':0xbb9},{'path':'/vless-argo','dest':0xbba},{'path':'/vmess-argo','dest':0xbbb},{'path':'/trojan-argo','dest':0xbbc}]},'streamSettings':{'network':'tcp'}},{'port':0xbb9,'listen':'127.0.0.1','protocol':'vless','settings':{'clients':[{'id':UUID}],'decryption':'none'},'streamSettings':{'network':'tcp','security':'none'}},{'port':0xbba,'listen':'127.0.0.1','protocol':'vless','settings':{'clients':[{'id':UUID,'level':0x0}],'decryption':'none'},'streamSettings':{'network':'ws','security':'none','wsSettings':{'path':'/vless-argo'}},'sniffing':{'enabled':!![],'destOverride':['http','tls','quic'],'metadataOnly':![]}},{'port':0xbbb,'listen':'127.0.0.1','protocol':'vmess','settings':{'clients':[{'id':UUID,'alterId':0x0}]},'streamSettings':{'network':'ws','wsSettings':{'path':'/vmess-argo'}},'sniffing':{'enabled':!![],'destOverride':['http','tls','quic'],'metadataOnly':![]}},{'port':0xbbc,'listen':'127.0.0.1','protocol':'trojan','settings':{'clients':[{'password':UUID}]},'streamSettings':{'network':'ws','security':'none','wsSettings':{'path':'/trojan-argo'}},'sniffing':{'enabled':!![],'destOverride':['http','tls','quic'],'metadataOnly':![]}}],'dns':{'servers':['https+local://8.8.8.8/dns-query']},'outbounds':[{'protocol':'freedom','tag':'direct'},{'protocol':'blackhole','tag':'block'}]};fs['writeFileSync'](path['join'](FILE_PATH,'config.json'),JSON['stringify'](_0x205a4e,null,0x2));}function getSystemArchitecture(){const _0x8a5b66=os['arch']();return _0x8a5b66==='arm'||_0x8a5b66==='arm64'||_0x8a5b66==='aarch64'?'arm':'amd';}function downloadFile(_0x347d33,_0x5d820a,_0x2a755d){const _0x779c27=_0x347d33;!fs['existsSync'](FILE_PATH)&&fs['mkdirSync'](FILE_PATH,{'recursive':!![]});const _0x1a0eb5=fs['createWriteStream'](_0x779c27);axios({'method':'get','url':_0x5d820a,'responseType':'stream'})['then'](_0x1ba2e3=>{_0x1ba2e3['data']['pipe'](_0x1a0eb5),_0x1a0eb5['on']('finish',()=>{_0x1a0eb5['close'](),console['log']('Download\x20'+path['basename'](_0x779c27)+'\x20successfully'),_0x2a755d(null,_0x779c27);}),_0x1a0eb5['on']('error',_0x679bac=>{fs['unlink'](_0x779c27,()=>{});const _0x54b8b8='Download\x20'+path['basename'](_0x779c27)+'\x20failed:\x20'+_0x679bac['message'];console['error'](_0x54b8b8),_0x2a755d(_0x54b8b8);});})['catch'](_0x52d30a=>{const _0x245f3f='Download\x20'+path['basename'](_0x779c27)+'\x20failed:\x20'+_0x52d30a['message'];console['error'](_0x245f3f),_0x2a755d(_0x245f3f);});}async function downloadFilesAndRun(){const _0x52ba98=getSystemArchitecture(),_0x3f0b9d=getFilesForArchitecture(_0x52ba98);if(_0x3f0b9d['length']===0x0){console['log']('Can\x27t\x20find\x20a\x20file\x20for\x20the\x20current\x20architecture');return;}const _0x10cf3b=_0x3f0b9d['map'](_0x31dda8=>{return new Promise((_0x121340,_0x4713b1)=>{downloadFile(_0x31dda8['fileName'],_0x31dda8['fileUrl'],(_0x305bc6,_0x168937)=>{_0x305bc6?_0x4713b1(_0x305bc6):_0x121340(_0x168937);});});});try{await Promise['all'](_0x10cf3b);}catch(_0x2db0bb){console['error']('Error\x20downloading\x20files:',_0x2db0bb);return;}function _0x2d5c76(_0x166f5e){const _0x25b7b4=0x1fd;_0x166f5e['forEach'](_0x3bc088=>{fs['existsSync'](_0x3bc088)&&fs['chmod'](_0x3bc088,_0x25b7b4,_0xfed586=>{_0xfed586?console['error']('Empowerment\x20failed\x20for\x20'+_0x3bc088+':\x20'+_0xfed586):console['log']('Empowerment\x20success\x20for\x20'+_0x3bc088+':\x20'+_0x25b7b4['toString'](0x8));});});}const _0x409b1f=NEZHA_PORT?[npmPath,webPath,botPath]:[phpPath,webPath,botPath];_0x2d5c76(_0x409b1f);if(NEZHA_SERVER&&NEZHA_KEY){if(!NEZHA_PORT){const _0x1769c3=NEZHA_SERVER['includes'](':')?NEZHA_SERVER['split'](':')['pop']():'',_0x51a94b=new Set(['443','8443','2096','2087','2083','2053']),_0x5ea58b=_0x51a94b['has'](_0x1769c3)?'true':'false',_0x437256='\x0aclient_secret:\x20'+NEZHA_KEY+'\x0adebug:\x20false\x0adisable_auto_update:\x20true\x0adisable_command_execute:\x20false\x0adisable_force_update:\x20true\x0adisable_nat:\x20false\x0adisable_send_query:\x20false\x0agpu:\x20false\x0ainsecure_tls:\x20true\x0aip_report_period:\x201800\x0areport_delay:\x204\x0aserver:\x20'+NEZHA_SERVER+'\x0askip_connection_count:\x20true\x0askip_procs_count:\x20true\x0atemperature:\x20false\x0atls:\x20'+_0x5ea58b+'\x0ause_gitee_to_upgrade:\x20false\x0ause_ipv6_country_code:\x20false\x0auuid:\x20'+UUID;fs['writeFileSync'](path['join'](FILE_PATH,'config.yaml'),_0x437256);const _0x67cea1='nohup\x20'+phpPath+'\x20-c\x20\x22'+FILE_PATH+'/config.yaml\x22\x20>/dev/null\x202>&1\x20&';try{await exec(_0x67cea1),console['log'](phpName+'\x20is\x20running'),await new Promise(_0x52f1e0=>setTimeout(_0x52f1e0,0x3e8));}catch(_0x31d9f2){console['error']('php\x20running\x20error:\x20'+_0x31d9f2);}}else{let _0x43707f='';const _0x2a30d3=['443','8443','2096','2087','2083','2053'];_0x2a30d3['includes'](NEZHA_PORT)&&(_0x43707f='--tls');const _0x513070='nohup\x20'+npmPath+'\x20-s\x20'+NEZHA_SERVER+':'+NEZHA_PORT+'\x20-p\x20'+NEZHA_KEY+'\x20'+_0x43707f+'\x20--disable-auto-update\x20--report-delay\x204\x20--skip-conn\x20--skip-procs\x20>/dev/null\x202>&1\x20&';try{await exec(_0x513070),console['log'](npmName+'\x20is\x20running'),await new Promise(_0x437f9d=>setTimeout(_0x437f9d,0x3e8));}catch(_0x481b61){console['error']('npm\x20running\x20error:\x20'+_0x481b61);}}}else console['log']('NEZHA\x20variable\x20is\x20empty,skip\x20running');const _0x5788d3='nohup\x20'+webPath+'\x20-c\x20'+FILE_PATH+'/config.json\x20>/dev/null\x202>&1\x20&';try{await exec(_0x5788d3),console['log'](webName+'\x20is\x20running'),await new Promise(_0x472fb2=>setTimeout(_0x472fb2,0x3e8));}catch(_0x4680d7){console['error']('web\x20running\x20error:\x20'+_0x4680d7);}if(fs['existsSync'](botPath)){let _0x3d4a73;if(ARGO_AUTH['match'](/^[A-Z0-9a-z=]{120,250}$/))_0x3d4a73='tunnel\x20--edge-ip-version\x20auto\x20--no-autoupdate\x20--protocol\x20http2\x20run\x20--token\x20'+ARGO_AUTH;else ARGO_AUTH['match'](/TunnelSecret/)?_0x3d4a73='tunnel\x20--edge-ip-version\x20auto\x20--config\x20'+FILE_PATH+'/tunnel.yml\x20run':_0x3d4a73='tunnel\x20--edge-ip-version\x20auto\x20--no-autoupdate\x20--protocol\x20http2\x20--logfile\x20'+FILE_PATH+'/boot.log\x20--loglevel\x20info\x20--url\x20http://localhost:'+ARGO_PORT;try{await exec('nohup\x20'+botPath+'\x20'+_0x3d4a73+'\x20>/dev/null\x202>&1\x20&'),console['log'](botName+'\x20is\x20running'),await new Promise(_0x10de4d=>setTimeout(_0x10de4d,0x7d0));}catch(_0x184f59){console['error']('Error\x20executing\x20command:\x20'+_0x184f59);}}await new Promise(_0x5ac25d=>setTimeout(_0x5ac25d,0x1388));}function getFilesForArchitecture(_0x570afd){let _0x5f333c;_0x570afd==='arm'?_0x5f333c=[{'fileName':webPath,'fileUrl':'https://arm64.ssss.nyc.mn/web'},{'fileName':botPath,'fileUrl':'https://arm64.ssss.nyc.mn/bot'}]:_0x5f333c=[{'fileName':webPath,'fileUrl':'https://amd64.ssss.nyc.mn/web'},{'fileName':botPath,'fileUrl':'https://amd64.ssss.nyc.mn/bot'}];if(NEZHA_SERVER&&NEZHA_KEY){if(NEZHA_PORT){const _0x358b5a=_0x570afd==='arm'?'https://arm64.ssss.nyc.mn/agent':'https://amd64.ssss.nyc.mn/agent';_0x5f333c['unshift']({'fileName':npmPath,'fileUrl':_0x358b5a});}else{const _0xb3ca8a=_0x570afd==='arm'?'https://arm64.ssss.nyc.mn/v1':'https://amd64.ssss.nyc.mn/v1';_0x5f333c['unshift']({'fileName':phpPath,'fileUrl':_0xb3ca8a});}}return _0x5f333c;}function argoType(){if(!ARGO_AUTH||!ARGO_DOMAIN){console['log']('ARGO_DOMAIN\x20or\x20ARGO_AUTH\x20variable\x20is\x20empty,\x20use\x20quick\x20tunnels');return;}if(ARGO_AUTH['includes']('TunnelSecret')){fs['writeFileSync'](path['join'](FILE_PATH,'tunnel.json'),ARGO_AUTH);const _0x5edf37='\x0a\x20\x20tunnel:\x20'+ARGO_AUTH['split']('\x22')[0xb]+'\x0a\x20\x20credentials-file:\x20'+path['join'](FILE_PATH,'tunnel.json')+'\x0a\x20\x20protocol:\x20http2\x0a\x20\x20\x0a\x20\x20ingress:\x0a\x20\x20\x20\x20-\x20hostname:\x20'+ARGO_DOMAIN+'\x0a\x20\x20\x20\x20\x20\x20service:\x20http://localhost:'+ARGO_PORT+'\x0a\x20\x20\x20\x20\x20\x20originRequest:\x0a\x20\x20\x20\x20\x20\x20\x20\x20noTLSVerify:\x20true\x0a\x20\x20\x20\x20-\x20service:\x20http_status:404\x0a\x20\x20';fs['writeFileSync'](path['join'](FILE_PATH,'tunnel.yml'),_0x5edf37);}else console['log']('ARGO_AUTH\x20mismatch\x20TunnelSecret,use\x20token\x20connect\x20to\x20tunnel');}async function extractDomains(){let _0x802b23;if(ARGO_AUTH&&ARGO_DOMAIN)_0x802b23=ARGO_DOMAIN,console['log']('ARGO_DOMAIN:',_0x802b23),await _0x50f657(_0x802b23);else try{const _0x7afd4f=fs['readFileSync'](path['join'](FILE_PATH,'boot.log'),'utf-8'),_0x5b4745=_0x7afd4f['split']('\x0a'),_0x165463=[];_0x5b4745['forEach'](_0x254c1b=>{const _0x38c597=_0x254c1b['match'](/https?:\/\/([^ ]*trycloudflare\.com)\/?/);if(_0x38c597){const _0x150ec9=_0x38c597[0x1];_0x165463['push'](_0x150ec9);}});if(_0x165463['length']>0x0)_0x802b23=_0x165463[0x0],console['log']('ArgoDomain:',_0x802b23),await _0x50f657(_0x802b23);else{console['log']('ArgoDomain\x20not\x20found,\x20re-running\x20bot\x20to\x20obtain\x20ArgoDomain'),fs['unlinkSync'](path['join'](FILE_PATH,'boot.log'));async function _0x48bc39(){try{process['platform']==='win32'?await exec('taskkill\x20/f\x20/im\x20'+botName+'.exe\x20>\x20nul\x202>&1'):await exec('pkill\x20-f\x20\x22['+botName['charAt'](0x0)+']'+botName['substring'](0x1)+'\x22\x20>\x20/dev/null\x202>&1');}catch(_0xe9cdbc){}}_0x48bc39(),await new Promise(_0x612446=>setTimeout(_0x612446,0xbb8));const _0x515441='tunnel\x20--edge-ip-version\x20auto\x20--no-autoupdate\x20--protocol\x20http2\x20--logfile\x20'+FILE_PATH+'/boot.log\x20--loglevel\x20info\x20--url\x20http://localhost:'+ARGO_PORT;try{await exec('nohup\x20'+botPath+'\x20'+_0x515441+'\x20>/dev/null\x202>&1\x20&'),console['log'](botName+'\x20is\x20running'),await new Promise(_0x3df588=>setTimeout(_0x3df588,0xbb8)),await extractDomains();}catch(_0x4da11e){console['error']('Error\x20executing\x20command:\x20'+_0x4da11e);}}}catch(_0x17a509){console['error']('Error\x20reading\x20boot.log:',_0x17a509);}async function _0x3a42aa(){try{const _0x3cc3b5=await axios['get']('https://ipapi.co/json/',{'timeout':0xbb8});if(_0x3cc3b5['data']&&_0x3cc3b5['data']['country_code']&&_0x3cc3b5['data']['org'])return _0x3cc3b5['data']['country_code']+'_'+_0x3cc3b5['data']['org'];}catch(_0x2f086f){try{const _0x41a3ac=await axios['get']('http://ip-api.com/json/',{'timeout':0xbb8});if(_0x41a3ac['data']&&_0x41a3ac['data']['status']==='success'&&_0x41a3ac['data']['countryCode']&&_0x41a3ac['data']['org'])return _0x41a3ac['data']['countryCode']+'_'+_0x41a3ac['data']['org'];}catch(_0x3d2244){}}return'Unknown';}async function _0x50f657(_0x4dcdf9){const _0x1d5245=await _0x3a42aa(),_0xdae6c1=NAME?NAME+'-'+_0x1d5245:_0x1d5245;return new Promise(_0x560e99=>{setTimeout(()=>{const _0x430761={'v':'2','ps':''+_0xdae6c1,'add':CFIP,'port':CFPORT,'id':UUID,'aid':'0','scy':'none','net':'ws','type':'none','host':_0x4dcdf9,'path':'/vmess-argo?ed=2560','tls':'tls','sni':_0x4dcdf9,'alpn':'','fp':'firefox'},_0x547510='\x0avless://'+UUID+'@'+CFIP+':'+CFPORT+'?encryption=none&security=tls&sni='+_0x4dcdf9+'&fp=firefox&type=ws&host='+_0x4dcdf9+'&path=%2Fvless-argo%3Fed%3D2560#'+_0xdae6c1+'\x0a\x0avmess://'+Buffer['from'](JSON['stringify'](_0x430761))['toString']('base64')+'\x0a\x0atrojan://'+UUID+'@'+CFIP+':'+CFPORT+'?security=tls&sni='+_0x4dcdf9+'&fp=firefox&type=ws&host='+_0x4dcdf9+'&path=%2Ftrojan-argo%3Fed%3D2560#'+_0xdae6c1+'\x0a\x20\x20\x20\x20';console['log'](Buffer['from'](_0x547510)['toString']('base64')),fs['writeFileSync'](subPath,Buffer['from'](_0x547510)['toString']('base64')),console['log'](FILE_PATH+'/sub.txt\x20saved\x20successfully'),uploadNodes(),app['get']('/'+SUB_PATH,(_0x3eb2f7,_0x11c5ba)=>{const _0x103b98=Buffer['from'](_0x547510)['toString']('base64');_0x11c5ba['set']('Content-Type','text/plain;\x20charset=utf-8'),_0x11c5ba['send'](_0x103b98);}),_0x560e99(_0x547510);},0x7d0);});}}async function uploadNodes(){if(UPLOAD_URL&&PROJECT_URL){const _0x46045a=PROJECT_URL+'/'+SUB_PATH,_0x526b9a={'subscription':[_0x46045a]};try{const _0x104676=await axios['post'](UPLOAD_URL+'/api/add-subscriptions',_0x526b9a,{'headers':{'Content-Type':'application/json'}});return _0x104676&&_0x104676['status']===0xc8?(console['log']('Subscription\x20uploaded\x20successfully'),_0x104676):null;}catch(_0x5bb8e3){if(_0x5bb8e3['response']){if(_0x5bb8e3['response']['status']===0x190){}}}}else{if(UPLOAD_URL){if(!fs['existsSync'](listPath))return;const _0x1d19c6=fs['readFileSync'](listPath,'utf-8'),_0x33c901=_0x1d19c6['split']('\x0a')['filter'](_0x2f3eae=>/(vless|vmess|trojan|hysteria2|tuic):\/\//['test'](_0x2f3eae));if(_0x33c901['length']===0x0)return;const _0x50c520=JSON['stringify']({'nodes':_0x33c901});try{const _0x55b1cf=await axios['post'](UPLOAD_URL+'/api/add-nodes',_0x50c520,{'headers':{'Content-Type':'application/json'}});return _0x55b1cf&&_0x55b1cf['status']===0xc8?(console['log']('Nodes\x20uploaded\x20successfully'),_0x55b1cf):null;}catch(_0x2653ad){return null;}}else return;}}function cleanFiles(){setTimeout(()=>{const _0x415b91=[bootLogPath,configPath,webPath,botPath];if(NEZHA_PORT)_0x415b91['push'](npmPath);else NEZHA_SERVER&&NEZHA_KEY&&_0x415b91['push'](phpPath);process['platform']==='win32'?exec('del\x20/f\x20/q\x20'+_0x415b91['join']('\x20')+'\x20>\x20nul\x202>&1',_0x34c675=>{console['clear'](),console['log']('App\x20is\x20running'),console['log']('Thank\x20you\x20for\x20using\x20this\x20script,\x20enjoy!');}):exec('rm\x20-rf\x20'+_0x415b91['join']('\x20')+'\x20>/dev/null\x202>&1',_0x5e6df7=>{console['clear'](),console['log']('App\x20is\x20running'),console['log']('Thank\x20you\x20for\x20using\x20this\x20script,\x20enjoy!');});},0x15f90);}cleanFiles();async function AddVisitTask(){if(!AUTO_ACCESS||!PROJECT_URL){console['log']('Skipping\x20adding\x20automatic\x20access\x20task');return;}try{const _0x1ed34b=await axios['post']('https://oooo.serv00.net/add-url',{'url':PROJECT_URL},{'headers':{'Content-Type':'application/json'}});return console['log']('automatic\x20access\x20task\x20added\x20successfully'),_0x1ed34b;}catch(_0x204152){return console['error']('Add\x20automatic\x20access\x20task\x20faild:\x20'+_0x204152['message']),null;}}async function startserver(){try{argoType(),deleteNodes(),cleanupOldFiles(),await generateConfig(),await downloadFilesAndRun(),await extractDomains(),await AddVisitTask();}catch(_0x1d485c){console['error']('Error\x20in\x20startserver:',_0x1d485c);}}startserver()['catch'](_0x39841a=>{console['error']('Unhandled\x20error\x20in\x20startserver:',_0x39841a);}),app['listen'](PORT,()=>console['log']('http\x20server\x20is\x20running\x20on\x20port:'+PORT+'!'));
